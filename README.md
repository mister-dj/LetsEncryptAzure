# Introduction 
This repo contains scripts that allow you to automatically request and apply Let's Encrypt certificates to Azure App Proxy applications. They can be easily modified for other Azure resources as well.

Please note that I've used Graph for setting the application certificate, as the "official" PowerShell cmdlet for doing so is part of the AzureAD module which is [slated for deprecation in March 2024](https://techcommunity.microsoft.com/t5/microsoft-entra-blog/important-azure-ad-graph-retirement-and-powershell-module/ba-p/3848270).


# Getting Started
1.	Setup process
    1. Create Azure Automation Account
    2. Create an Azure Key Vault (or use an existing one)
        - It's strongly recommended to use [RBAC permissions](https://learn.microsoft.com/en-us/azure/key-vault/general/rbac-guide?tabs=azure-cli) for your Key Vault items
    3. Install the needed modules for the Automation Account (see Software Dependencies below)
    4. Delegate the needed Graph API permissions to the Managed Identity of the Automation Account
        - Microsoft documentation [here](https://techcommunity.microsoft.com/t5/azure-integration-services-blog/grant-graph-api-permission-to-managed-identity-object/ba-p/2792127)
        - See the Permissions section for more info
    5. Add the Runbooks to the Automation Account
        - Optionally, you can [enable Source control](https://learn.microsoft.com/en-us/azure/automation/source-control-integration) on the Automation account to link it to Azure DevOps
    6. Create scheduled jobs as needed - this is where you can specify the parameter values for the script
2.	Software Dependencies
    These scripts have the following PowerShell 7 (runtime version 7.2) module dependencies:
    - [Posh-ACME](https://poshac.me/docs/v4/), used for requesting the LE certificate
    - Microsoft.Graph.Authentication, used for authenticating to Graph (using Managed Identity)
    - Microsoft.Graph.Applications, used for looking up applications - note that this could be substituted for the beta version if desired
    - Microsoft.Graph.Beta.Applications, used to apply the cert to the App Proxy Application.
    - Az.KeyVault, which for Azure sandbox workers is pre-installed
    - Az.Accounts, which for Azure sandbox workers is pre-installed
    PowerShell Runbook runtime version 7.2 is recommended
3.	API references
    Let's Encrypt's ACME API is used, as are Microsoft Graph (stable and beta) and Azure PowerShell cmdlets.

# Alternative Scenarios
This was initially devloped as a work project, where the DNS provider in use was Namecheap. Because their API required IP whitelisting I stood up a small Windows VM (B1ms or similar SKU, I recommend at least 2GB memory for Windows VMs) as a Hybrid Worker and placed it behind static IP via NAT GW/Public IP. For many DNS providers (e.g. Cloudflare) this is not needed or optional. 

Note: if you use a Hybrid Worker VM be aware that the certificate files generated by Posh-ACME are stored persistently on the machine. I recommend modifying the script to remove them after, or regularly deleting and rebuilding the VM.

For my personal use, the script is written to use Posh-ACME's [Cloudlfare Plugin](https://poshac.me/docs/v4/Plugins/Cloudflare/#global-api-key_1). The script can be easily modified for other Posh-ACME plugins as needed, or even extended to other Azure services which can use SSL certificates.

# Build and Test
The scripts are written with an ErrorAction of Stop and without try/catch statements so that any errors will cause the job to fail with errors directly written to the output, to facilitate troubleshooting.

Note: when testing code I strongly recommend using LE's staging server so as to not hit any rate limits.

# Permissions
The script uses Graph to set the certificate for the App Prox application. This requires one-time configuration of permission.
[The specific operation](https://learn.microsoft.com/en-us/graph/api/application-addkey?view=graph-rest-beta&tabs=http#permissions) that is done has [Application.ReadWrite.OwnedBy](https://learn.microsoft.com/en-us/graph/permissions-reference#applicationreadwriteownedby) as the least privileges required.
This requires setting the Managed Identity of the Automation Account as an Owner of the App Proxy application. See the "Permissions Script" included in this repo for how to set that.

The Managed Identity will also need read access to the Key Vault secret which the API key is stored in. The included RBAC role "Key Vault Secrets User" works well for this. Microsoft documentation for that [here](https://learn.microsoft.com/en-us/azure/key-vault/general/rbac-guide?tabs=azure-cli).

# Cost/Pricing Considerations
Azure Automation pricing is very cheap, with plenty of free tier included. Please see the official [Microsoft documentation regarding Azure Automation pricing](https://azure.microsoft.com/en-us/pricing/details/automation/) for full details.

# Roadmap
As of December 2023 this project is considered complete, with no further development intended (though that doesn't mean I won't continue working on it in the future).

One minor thing that I may look into is how to automate renewals (instead of issuing new certs) since I suspect the contact email will get cert expiry notifications if the certs are re-issued instead of renewed, but this doesn't affect functionality.

# Contribute
Feel free to fork this into your own project. If you'd prefer to contribute to this repo, please [contact me](https://blog.donmorgan.net/blogger-gb-contact/) via Reddit or LinkedIn.

# Licensing
This repo is licensed under the [GPL v3.0 license](https://choosealicense.com/licenses/gpl-3.0/)
